<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This is the implementation of the pass which transforms generators into state machines."><title>rustc_mir_transform::generator - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-47e7ab555ef2818a.css" id="mainThemeStyle"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="rustc_mir_transform" data-themes="" data-resource-suffix="" data-rustdoc-version="1.74.0-nightly (58eefc33a 2023-08-24)" data-channel="nightly" data-search-js="search-6dfdfced5eff6596.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-b2d31d2efc7e9b67.css" data-theme-dark-css="dark-3388a2fb2ef8066b.css" data-theme-ayu-css="ayu-8c3c66a6cf12cb2f.css" ><script src="../../static.files/storage-db41da1a38ea3cb8.js"></script><script defer src="../../static.files/main-ef3a2de404864b0b.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../static.files/light-b2d31d2efc7e9b67.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../static.files/dark-3388a2fb2ef8066b.css"><link rel="stylesheet" href="../../static.files/noscript-cffde32267a19fd6.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../rustc_mir_transform/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../rustc_mir_transform/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Module generator</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#constants">Constants</a></li><li><a href="#functions">Functions</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press â€˜Sâ€™ to search, â€˜?â€™ for more optionsâ€¦" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../index.html">rustc_mir_transform</a>::<wbr><a class="mod" href="#">generator</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../../src/rustc_mir_transform/generator.rs.html#1-1970">source</a> Â· <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This is the implementation of the pass which transforms generators into state machines.</p>
<p>MIR generation for generators creates a function which has a self argument which
passes by value. This argument is effectively a generator type which only contains upvars and
is only used for this argument inside the MIR for the generator.
It is passed by value to enable upvars to be moved out of it. Drop elaboration runs on that
MIR before this pass and creates drop flags for MIR locals.
It will also drop the generator argument (which only consists of upvars) if any of the upvars
are moved out of. This pass elaborates the drops of upvars / generator argument in the case
that none of the upvars were moved out of. This is because we cannot have any drops of this
generator in the MIR, since it is used to create the drop glue for the generator. Weâ€™d get
infinite recursion otherwise.</p>
<p>This pass creates the implementation for either the <code>Generator::resume</code> or <code>Future::poll</code>
function and the drop shim for the generator based on the MIR input.
It converts the generator argument from Self to &amp;mut Self adding derefs in the MIR as needed.
It computes the final layout of the generator struct which looks like this:
First upvars are stored
It is followed by the generator state field.
Then finally the MIR locals which are live across a suspension point are stored.
<code>ignore (illustrative) struct Generator { upvars..., state: u32, mir_locals..., } </code>
This pass computes the meaning of the state field and the MIR locals which are live
across a suspension point. There are however three hardcoded generator states:
0 - Generator have not been resumed yet
1 - Generator has returned / is completed
2 - Generator has been poisoned</p>
<p>It also rewrites <code>return x</code> and <code>yield y</code> as setting a new generator state and returning
<code>GeneratorState::Complete(x)</code> and <code>GeneratorState::Yielded(y)</code>,
or <code>Poll::Ready(x)</code> and <code>Poll::Pending</code> respectively.
MIR locals which are live across a suspension point are moved to the generator struct
with references to them being updated with references to the generator struct.</p>
<p>The pass creates two functions which have a switch on the generator state giving
the action to take.</p>
<p>One of them is the implementation of <code>Generator::resume</code> / <code>Future::poll</code>.
For generators with state 0 (unresumed) it starts the execution of the generator.
For generators with state 1 (returned) and state 2 (poisoned) it panics.
Otherwise it continues the execution from the last suspension point.</p>
<p>The other function is the drop glue for the generator.
For generators with state 0 (unresumed) it drops the upvars of the generator.
For generators with state 1 (returned) and state 2 (poisoned) it does nothing.
Otherwise it drops all the values in scope at the last suspension point.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.DerefArgVisitor.html" title="struct rustc_mir_transform::generator::DerefArgVisitor">DerefArgVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.EnsureGeneratorFieldAssignmentsNeverAlias.html" title="struct rustc_mir_transform::generator::EnsureGeneratorFieldAssignmentsNeverAlias">EnsureGeneratorFieldAssignmentsNeverAlias</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Looks for any assignments between locals (e.g., <code>_4 = _5</code>) that will both be converted to fields
in the generator state machine but whose storage is not marked as conflicting</div></li><li><div class="item-name"><a class="struct" href="struct.GeneratorSavedLocals.html" title="struct rustc_mir_transform::generator::GeneratorSavedLocals">GeneratorSavedLocals</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">The set of <code>Local</code>s that must be saved across yield points.</div></li><li><div class="item-name"><a class="struct" href="struct.LivenessInfo.html" title="struct rustc_mir_transform::generator::LivenessInfo">LivenessInfo</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.PinArgVisitor.html" title="struct rustc_mir_transform::generator::PinArgVisitor">PinArgVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.RenameLocalVisitor.html" title="struct rustc_mir_transform::generator::RenameLocalVisitor">RenameLocalVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.StateTransform.html" title="struct rustc_mir_transform::generator::StateTransform">StateTransform</a></div></li><li><div class="item-name"><a class="struct" href="struct.StorageConflictVisitor.html" title="struct rustc_mir_transform::generator::StorageConflictVisitor">StorageConflictVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.SuspendCheckData.html" title="struct rustc_mir_transform::generator::SuspendCheckData">SuspendCheckData</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="struct" href="struct.SuspensionPoint.html" title="struct rustc_mir_transform::generator::SuspensionPoint">SuspensionPoint</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">A <code>yield</code> point in the generator.</div></li><li><div class="item-name"><a class="struct" href="struct.TransformVisitor.html" title="struct rustc_mir_transform::generator::TransformVisitor">TransformVisitor</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li></ul><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.Operation.html" title="enum rustc_mir_transform::generator::Operation">Operation</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">An operation that can be performed on a generator.</div></li></ul><h2 id="constants" class="small-section-header"><a href="#constants">Constants</a></h2><ul class="item-table"><li><div class="item-name"><a class="constant" href="constant.POISONED.html" title="constant rustc_mir_transform::generator::POISONED">POISONED</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Generator has panicked and is poisoned.</div></li><li><div class="item-name"><a class="constant" href="constant.RESERVED_VARIANTS.html" title="constant rustc_mir_transform::generator::RESERVED_VARIANTS">RESERVED_VARIANTS</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Number of variants to reserve in generator state. Corresponds to
<code>UNRESUMED</code> (beginning of a generator) and <code>RETURNED</code>/<code>POISONED</code>
(end of a generator) states.</div></li><li><div class="item-name"><a class="constant" href="constant.RETURNED.html" title="constant rustc_mir_transform::generator::RETURNED">RETURNED</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Generator has returned / is completed.</div></li><li><div class="item-name"><a class="constant" href="constant.SELF_ARG.html" title="constant rustc_mir_transform::generator::SELF_ARG">SELF_ARG</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="constant" href="constant.UNRESUMED.html" title="constant rustc_mir_transform::generator::UNRESUMED">UNRESUMED</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Generator has not been resumed yet.</div></li></ul><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.can_return.html" title="fn rustc_mir_transform::generator::can_return">can_return</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.can_unwind.html" title="fn rustc_mir_transform::generator::can_unwind">can_unwind</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_must_not_suspend_def.html" title="fn rustc_mir_transform::generator::check_must_not_suspend_def">check_must_not_suspend_def</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_must_not_suspend_ty.html" title="fn rustc_mir_transform::generator::check_must_not_suspend_ty">check_must_not_suspend_ty</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_suspend_tys.html" title="fn rustc_mir_transform::generator::check_suspend_tys">check_suspend_tys</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.compute_layout.html" title="fn rustc_mir_transform::generator::compute_layout">compute_layout</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.compute_storage_conflicts.html" title="fn rustc_mir_transform::generator::compute_storage_conflicts">compute_storage_conflicts</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">For every saved local, looks for which locals are StorageLive at the same
time. Generates a bitset for every local of all the other locals that may be
StorageLive simultaneously with that local. This is used in the layout
computation; see <code>GeneratorLayout</code> for more.</div></li><li><div class="item-name"><a class="fn" href="fn.create_cases.html" title="fn rustc_mir_transform::generator::create_cases">create_cases</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.create_generator_drop_shim.html" title="fn rustc_mir_transform::generator::create_generator_drop_shim">create_generator_drop_shim</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.create_generator_resume_function.html" title="fn rustc_mir_transform::generator::create_generator_resume_function">create_generator_resume_function</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.elaborate_generator_drops.html" title="fn rustc_mir_transform::generator::elaborate_generator_drops">elaborate_generator_drops</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.eliminate_get_context_call.html" title="fn rustc_mir_transform::generator::eliminate_get_context_call">eliminate_get_context_call</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.insert_clean_drop.html" title="fn rustc_mir_transform::generator::insert_clean_drop">insert_clean_drop</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.insert_panic_block.html" title="fn rustc_mir_transform::generator::insert_panic_block">insert_panic_block</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.insert_switch.html" title="fn rustc_mir_transform::generator::insert_switch">insert_switch</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Replaces the entry point of <code>body</code> with a block that switches on the generator discriminant and
dispatches to blocks according to <code>cases</code>.</div></li><li><div class="item-name"><a class="fn" href="fn.insert_term_block.html" title="fn rustc_mir_transform::generator::insert_term_block">insert_term_block</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.locals_live_across_suspend_points.html" title="fn rustc_mir_transform::generator::locals_live_across_suspend_points">locals_live_across_suspend_points</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.make_generator_state_argument_indirect.html" title="fn rustc_mir_transform::generator::make_generator_state_argument_indirect">make_generator_state_argument_indirect</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.make_generator_state_argument_pinned.html" title="fn rustc_mir_transform::generator::make_generator_state_argument_pinned">make_generator_state_argument_pinned</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.mir_generator_witnesses.html" title="fn rustc_mir_transform::generator::mir_generator_witnesses">mir_generator_witnesses</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.replace_base.html" title="fn rustc_mir_transform::generator::replace_base">replace_base</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.replace_local.html" title="fn rustc_mir_transform::generator::replace_local">replace_local</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Allocates a new local and replaces all references of <code>local</code> with it. Returns the new local.</div></li><li><div class="item-name"><a class="fn" href="fn.replace_resume_ty_local.html" title="fn rustc_mir_transform::generator::replace_resume_ty_local">replace_resume_ty_local</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div></li><li><div class="item-name"><a class="fn" href="fn.sanitize_witness.html" title="fn rustc_mir_transform::generator::sanitize_witness">sanitize_witness</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Validates the typeck view of the generator against the actual set of types saved between
yield points.</div></li><li><div class="item-name"><a class="fn" href="fn.transform_async_context.html" title="fn rustc_mir_transform::generator::transform_async_context">transform_async_context</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </div><div class="desc docblock-short">Transforms the <code>body</code> of the generator applying the following transforms:</div></li></ul></section></div></main></body></html>