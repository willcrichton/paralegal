<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Minimal Specialization"><title>rustc_hir_analysis::impl_wf_check::min_specialization - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-47e7ab555ef2818a.css" id="mainThemeStyle"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="rustc_hir_analysis" data-themes="" data-resource-suffix="" data-rustdoc-version="1.74.0-nightly (58eefc33a 2023-08-24)" data-channel="nightly" data-search-js="search-6dfdfced5eff6596.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-b2d31d2efc7e9b67.css" data-theme-dark-css="dark-3388a2fb2ef8066b.css" data-theme-ayu-css="ayu-8c3c66a6cf12cb2f.css" ><script src="../../../static.files/storage-db41da1a38ea3cb8.js"></script><script defer src="../../../static.files/main-ef3a2de404864b0b.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../../static.files/light-b2d31d2efc7e9b67.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../../static.files/dark-3388a2fb2ef8066b.css"><link rel="stylesheet" href="../../../static.files/noscript-cffde32267a19fd6.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../../rustc_hir_analysis/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../../rustc_hir_analysis/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Module min_specialization</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#functions">Functions</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‚ÄòS‚Äô to search, ‚Äò?‚Äô for more options‚Ä¶" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../index.html">rustc_hir_analysis</a>::<wbr><a href="../index.html">impl_wf_check</a>::<wbr><a class="mod" href="#">min_specialization</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../../../src/rustc_hir_analysis/impl_wf_check/min_specialization.rs.html#1-522">source</a> ¬∑ <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="minimal-specialization"><a href="#minimal-specialization">Minimal Specialization</a></h2>
<p>This module contains the checks for sound specialization used when the
<code>min_specialization</code> feature is enabled. This requires that the impl is
<em>always applicable</em>.</p>
<p>If <code>impl1</code> specializes <code>impl2</code> then <code>impl1</code> is always applicable if we know
that all the bounds of <code>impl2</code> are satisfied, and all of the bounds of
<code>impl1</code> are satisfied for some choice of lifetimes then we know that
<code>impl1</code> applies for any choice of lifetimes.</p>
<h3 id="basic-approach"><a href="#basic-approach">Basic approach</a></h3>
<p>To enforce this requirement on specializations we take the following
approach:</p>
<ol>
<li>Match up the args for <code>impl2</code> so that the implemented trait and
self-type match those for <code>impl1</code>.</li>
<li>Check for any direct use of <code>'static</code> in the args of <code>impl2</code>.</li>
<li>Check that all of the generic parameters of <code>impl1</code> occur at most once
in the <em>unconstrained</em> args for <code>impl2</code>. A parameter is constrained if
its value is completely determined by an associated type projection
predicate.</li>
<li>Check that all predicates on <code>impl1</code> either exist on <code>impl2</code> (after
matching args), or are well-formed predicates for the trait‚Äôs type
arguments.</li>
</ol>
<h3 id="example"><a href="#example">Example</a></h3>
<p>Suppose we have the following always applicable impl:</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">‚ìò</a><pre class="rust rust-example-rendered"><code><span class="kw">impl</span>&lt;T&gt; SpecExtend&lt;T&gt; <span class="kw">for </span>std::vec::IntoIter&lt;T&gt; { <span class="comment">/* specialized impl */ </span>}
<span class="kw">impl</span>&lt;T, I: Iterator&lt;Item=T&gt;&gt; SpecExtend&lt;T&gt; <span class="kw">for </span>I { <span class="comment">/* default impl */ </span>}</code></pre></div>
<p>We get that the subst for <code>impl2</code> are <code>[T, std::vec::IntoIter&lt;T&gt;]</code>. <code>T</code> is
constrained to be <code>&lt;I as Iterator&gt;::Item</code>, so we check only
<code>std::vec::IntoIter&lt;T&gt;</code> for repeated parameters, which it doesn‚Äôt have. The
predicates of <code>impl1</code> are only <code>T: Sized</code>, which is also a predicate of
<code>impl2</code>. So this specialization is sound.</p>
<h3 id="extensions"><a href="#extensions">Extensions</a></h3>
<p>Unfortunately not all specializations in the standard library are allowed
by this. So there are two extensions to these rules that allow specializing
on some traits: that is, using them as bounds on the specializing impl,
even when they don‚Äôt occur in the base impl.</p>
<h4 id="rustc_specialization_trait"><a href="#rustc_specialization_trait">rustc_specialization_trait</a></h4>
<p>If a trait is always applicable, then it‚Äôs sound to specialize on it. We
check trait is always applicable in the same way as impls, except that step
4 is now ‚Äúall predicates on <code>impl1</code> are always applicable‚Äù. We require that
<code>specialization</code> or <code>min_specialization</code> is enabled to implement these
traits.</p>
<h4 id="rustc_unsafe_specialization_marker"><a href="#rustc_unsafe_specialization_marker">rustc_unsafe_specialization_marker</a></h4>
<p>There are also some specialization on traits with no methods, including the
stable <code>FusedIterator</code> trait. We allow marking marker traits with an
unstable attribute that means we ignore them in point 3 of the checks
above. This is unsound, in the sense that the specialized impl may be used
when it doesn‚Äôt apply, but we allow it in the short term since it can‚Äôt
cause use after frees with purely safe code in the same way as specializing
on traits with methods can.</p>
</div></details><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.check_always_applicable.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_always_applicable">check_always_applicable</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Check that <code>impl1</code> is a sound specialization</div></li><li><div class="item-name"><a class="fn" href="fn.check_constness.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_constness">check_constness</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Check that the specializing impl <code>impl1</code> is at least as const as the base
impl <code>impl2</code></div></li><li><div class="item-name"><a class="fn" href="fn.check_duplicate_params.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_duplicate_params">check_duplicate_params</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Check that parameters of the derived impl don‚Äôt occur more than once in the
equated args of the base impl.</div></li><li><div class="item-name"><a class="fn" href="fn.check_has_items.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_has_items">check_has_items</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_min_specialization.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_min_specialization">check_min_specialization</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_predicates.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_predicates">check_predicates</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Check whether predicates on the specializing impl (<code>impl1</code>) are allowed.</div></li><li><div class="item-name"><a class="fn" href="fn.check_specialization_on.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_specialization_on">check_specialization_on</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="fn" href="fn.check_static_lifetimes.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::check_static_lifetimes">check_static_lifetimes</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Check that <code>'static</code> lifetimes are not introduced by the specializing impl.</div></li><li><div class="item-name"><a class="fn" href="fn.get_impl_args.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::get_impl_args">get_impl_args</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Given a specializing impl <code>impl1</code>, and the base impl <code>impl2</code>, returns two
substitutions <code>(S1, S2)</code> that equate their trait references. The returned
types are expressed in terms of the generics of <code>impl1</code>.</div></li><li><div class="item-name"><a class="fn" href="fn.parent_specialization_node.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::parent_specialization_node">parent_specialization_node</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="fn" href="fn.trait_predicate_kind.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::trait_predicate_kind">trait_predicate_kind</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="fn" href="fn.trait_predicates_eq.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::trait_predicates_eq">trait_predicates_eq</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Checks if some predicate on the specializing impl (<code>predicate1</code>) is the same
as some predicate on the base impl (<code>predicate2</code>).</div></li><li><div class="item-name"><a class="fn" href="fn.unconstrained_parent_impl_args.html" title="fn rustc_hir_analysis::impl_wf_check::min_specialization::unconstrained_parent_impl_args">unconstrained_parent_impl_args</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Returns a list of all of the unconstrained subst of the given impl.</div></li></ul></section></div></main></body></html>