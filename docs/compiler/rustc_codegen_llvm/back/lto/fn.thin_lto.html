<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Prepare “thin” LTO to get run on these modules."><title>thin_lto in rustc_codegen_llvm::back::lto - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-47e7ab555ef2818a.css" id="mainThemeStyle"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="rustc_codegen_llvm" data-themes="" data-resource-suffix="" data-rustdoc-version="1.74.0-nightly (58eefc33a 2023-08-24)" data-channel="nightly" data-search-js="search-6dfdfced5eff6596.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-b2d31d2efc7e9b67.css" data-theme-dark-css="dark-3388a2fb2ef8066b.css" data-theme-ayu-css="ayu-8c3c66a6cf12cb2f.css" ><script src="../../../static.files/storage-db41da1a38ea3cb8.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../../static.files/main-ef3a2de404864b0b.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../../static.files/light-b2d31d2efc7e9b67.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../../static.files/dark-3388a2fb2ef8066b.css"><link rel="stylesheet" href="../../../static.files/noscript-cffde32267a19fd6.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../../rustc_codegen_llvm/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../../rustc_codegen_llvm/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><div class="sidebar-elems"><h2><a href="index.html">In rustc_codegen_llvm::back::lto</a></h2></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Function <a href="../../index.html">rustc_codegen_llvm</a>::<wbr><a href="../index.html">back</a>::<wbr><a href="index.html">lto</a>::<wbr><a class="fn" href="#">thin_lto</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../../../src/rustc_codegen_llvm/back/lto.rs.html#422-578">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><pre class="rust item-decl"><code>fn thin_lto(
    cgcx: &amp;<a class="struct" href="../../../rustc_codegen_ssa/back/write/struct.CodegenContext.html" title="struct rustc_codegen_ssa::back::write::CodegenContext">CodegenContext</a>&lt;<a class="struct" href="../../struct.LlvmCodegenBackend.html" title="struct rustc_codegen_llvm::LlvmCodegenBackend">LlvmCodegenBackend</a>&gt;,
    diag_handler: &amp;<a class="struct" href="../../../rustc_errors/struct.Handler.html" title="struct rustc_errors::Handler">Handler</a>,
    modules: <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;(<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/string/struct.String.html" title="struct alloc::string::String">String</a>, <a class="struct" href="struct.ThinBuffer.html" title="struct rustc_codegen_llvm::back::lto::ThinBuffer">ThinBuffer</a>)&gt;,
    serialized_modules: <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;(<a class="enum" href="../../../rustc_codegen_ssa/back/lto/enum.SerializedModule.html" title="enum rustc_codegen_ssa::back::lto::SerializedModule">SerializedModule</a>&lt;<a class="struct" href="struct.ModuleBuffer.html" title="struct rustc_codegen_llvm::back::lto::ModuleBuffer">ModuleBuffer</a>&gt;, <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/ffi/c_str/struct.CString.html" title="struct alloc::ffi::c_str::CString">CString</a>)&gt;,
    cached_modules: <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;(<a class="enum" href="../../../rustc_codegen_ssa/back/lto/enum.SerializedModule.html" title="enum rustc_codegen_ssa::back::lto::SerializedModule">SerializedModule</a>&lt;<a class="struct" href="struct.ModuleBuffer.html" title="struct rustc_codegen_llvm::back::lto::ModuleBuffer">ModuleBuffer</a>&gt;, <a class="struct" href="../../../rustc_query_system/dep_graph/graph/struct.WorkProduct.html" title="struct rustc_query_system::dep_graph::graph::WorkProduct">WorkProduct</a>)&gt;,
    symbols_below_threshold: &amp;[<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.pointer.html">*const </a><a class="type" href="https://docs.rs/libc/0.2.147/libc/unix/linux_like/linux/gnu/b64/x86_64/type.c_char.html" title="type libc::unix::linux_like::linux::gnu::b64::x86_64::c_char">c_char</a>]
) -&gt; <a class="enum" href="https://doc.rust-lang.org/nightly/core/result/enum.Result.html" title="enum core::result::Result">Result</a>&lt;(<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="enum" href="../../../rustc_codegen_ssa/back/lto/enum.LtoModuleCodegen.html" title="enum rustc_codegen_ssa::back::lto::LtoModuleCodegen">LtoModuleCodegen</a>&lt;<a class="struct" href="../../struct.LlvmCodegenBackend.html" title="struct rustc_codegen_llvm::LlvmCodegenBackend">LlvmCodegenBackend</a>&gt;&gt;, <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../../rustc_query_system/dep_graph/graph/struct.WorkProduct.html" title="struct rustc_query_system::dep_graph::graph::WorkProduct">WorkProduct</a>&gt;), <a class="struct" href="../../../rustc_span/fatal_error/struct.FatalError.html" title="struct rustc_span::fatal_error::FatalError">FatalError</a>&gt;</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Prepare “thin” LTO to get run on these modules.</p>
<p>The general structure of ThinLTO is quite different from the structure of
“fat” LTO above. With “fat” LTO all LLVM modules in question are merged into
one giant LLVM module, and then we run more optimization passes over this
big module after internalizing most symbols. Thin LTO, on the other hand,
avoid this large bottleneck through more targeted optimization.</p>
<p>At a high level Thin LTO looks like:</p>
<ol>
<li>Prepare a “summary” of each LLVM module in question which describes
the values inside, cost of the values, etc.</li>
<li>Merge the summaries of all modules in question into one “index”</li>
<li>Perform some global analysis on this index</li>
<li>For each module, use the index and analysis calculated previously to
perform local transformations on the module, for example inlining
small functions from other modules.</li>
<li>Run thin-specific optimization passes over each module, and then code
generate everything at the end.</li>
</ol>
<p>The summary for each module is intended to be quite cheap, and the global
index is relatively quite cheap to create as well. As a result, the goal of
ThinLTO is to reduce the bottleneck on LTO and enable LTO to be used in more
situations. For example one cheap optimization is that we can parallelize
all codegen modules, easily making use of all the cores on a machine.</p>
<p>With all that in mind, the function here is designed at specifically just
calculating the <em>index</em> for ThinLTO. This index will then be shared amongst
all of the <code>LtoModuleCodegen</code> units returned below and destroyed once
they all go out of scope.</p>
</div></details></section></div></main></body></html>