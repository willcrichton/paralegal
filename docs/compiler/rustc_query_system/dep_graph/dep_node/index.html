<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This module defines the `DepNode` type which the compiler uses to represent nodes in the dependency graph. A `DepNode` consists of a `DepKind` (which specifies the kind of thing it represents, like a piece of HIR, MIR, etc) and a `Fingerprint`, a 128 bit hash value the exact meaning of which depends on the node’s `DepKind`. Together, the kind and the fingerprint fully identify a dependency node, even across multiple compilation sessions. In other words, the value of the fingerprint does not depend on anything that is specific to a given compilation session, like an unpredictable interning key (e.g., NodeId, DefId, Symbol) or the numeric value of a pointer. The concept behind this could be compared to how git commit hashes uniquely identify a given commit and has a few advantages:"><title>rustc_query_system::dep_graph::dep_node - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-47e7ab555ef2818a.css" id="mainThemeStyle"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="rustc_query_system" data-themes="" data-resource-suffix="" data-rustdoc-version="1.74.0-nightly (58eefc33a 2023-08-24)" data-channel="nightly" data-search-js="search-6dfdfced5eff6596.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-b2d31d2efc7e9b67.css" data-theme-dark-css="dark-3388a2fb2ef8066b.css" data-theme-ayu-css="ayu-8c3c66a6cf12cb2f.css" ><script src="../../../static.files/storage-db41da1a38ea3cb8.js"></script><script defer src="../../../static.files/main-ef3a2de404864b0b.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../../static.files/light-b2d31d2efc7e9b67.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../../static.files/dark-3388a2fb2ef8066b.css"><link rel="stylesheet" href="../../../static.files/noscript-cffde32267a19fd6.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../../rustc_query_system/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../../rustc_query_system/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Module dep_node</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#traits">Traits</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../index.html">rustc_query_system</a>::<wbr><a href="../index.html">dep_graph</a>::<wbr><a class="mod" href="#">dep_node</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../../../src/rustc_query_system/dep_graph/dep_node.rs.html#1-260">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This module defines the <code>DepNode</code> type which the compiler uses to represent
nodes in the dependency graph. A <code>DepNode</code> consists of a <code>DepKind</code> (which
specifies the kind of thing it represents, like a piece of HIR, MIR, etc)
and a <code>Fingerprint</code>, a 128 bit hash value the exact meaning of which
depends on the node’s <code>DepKind</code>. Together, the kind and the fingerprint
fully identify a dependency node, even across multiple compilation sessions.
In other words, the value of the fingerprint does not depend on anything
that is specific to a given compilation session, like an unpredictable
interning key (e.g., NodeId, DefId, Symbol) or the numeric value of a
pointer. The concept behind this could be compared to how git commit hashes
uniquely identify a given commit and has a few advantages:</p>
<ul>
<li>A <code>DepNode</code> can simply be serialized to disk and loaded in another session
without the need to do any “rebasing (like we have to do for Spans and
NodeIds) or “retracing” like we had to do for <code>DefId</code> in earlier
implementations of the dependency graph.</li>
<li>A <code>Fingerprint</code> is just a bunch of bits, which allows <code>DepNode</code> to
implement <code>Copy</code>, <code>Sync</code>, <code>Send</code>, <code>Freeze</code>, etc.</li>
<li>Since we just have a bit pattern, <code>DepNode</code> can be mapped from disk into
memory without any post-processing (e.g., “abomination-style” pointer
reconstruction).</li>
<li>Because a <code>DepNode</code> is self-contained, we can instantiate <code>DepNodes</code> that
refer to things that do not exist anymore. In previous implementations
<code>DepNode</code> contained a <code>DefId</code>. A <code>DepNode</code> referring to something that
had been removed between the previous and the current compilation session
could not be instantiated because the current compilation session
contained no <code>DefId</code> for thing that had been removed.</li>
</ul>
<p><code>DepNode</code> definition happens in <code>rustc_middle</code> with the <code>define_dep_nodes!()</code> macro.
This macro defines the <code>DepKind</code> enum and a corresponding <code>DepConstructor</code> enum. The
<code>DepConstructor</code> enum links a <code>DepKind</code> to the parameters that are needed at runtime in order
to construct a valid <code>DepNode</code> fingerprint.</p>
<p>Because the macro sees what parameters a given <code>DepKind</code> requires, it can
“infer” some properties for each kind of <code>DepNode</code>:</p>
<ul>
<li>Whether a <code>DepNode</code> of a given kind has any parameters at all. Some
<code>DepNode</code>s could represent global concepts with only one value.</li>
<li>Whether it is possible, in principle, to reconstruct a query key from a
given <code>DepNode</code>. Many <code>DepKind</code>s only require a single <code>DefId</code> parameter,
in which case it is possible to map the node’s fingerprint back to the
<code>DefId</code> it was computed from. In other cases, too much information gets
lost during fingerprint computation.</li>
</ul>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.DepKindStruct.html" title="struct rustc_query_system::dep_graph::dep_node::DepKindStruct">DepKindStruct</a></div><div class="desc docblock-short">This struct stores metadata about each DepKind.</div></li><li><div class="item-name"><a class="struct" href="struct.DepNode.html" title="struct rustc_query_system::dep_graph::dep_node::DepNode">DepNode</a></div></li><li><div class="item-name"><a class="struct" href="struct.WorkProductId.html" title="struct rustc_query_system::dep_graph::dep_node::WorkProductId">WorkProductId</a></div><div class="desc docblock-short">A “work product” corresponds to a <code>.o</code> (or other) file that we
save in between runs. These IDs do not have a <code>DefId</code> but rather
some independent path or string that persists between runs without
the need to be mapped or unmapped. (This ensures we can serialize
them even in the absence of a tcx.)</div></li></ul><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.DepNodeParams.html" title="trait rustc_query_system::dep_graph::dep_node::DepNodeParams">DepNodeParams</a></div></li></ul></section></div></main></body></html>